# -*- coding: utf-8 -*-
"""Retail_ROI_App

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1k2FlDF59C2NRVvUTojd4HQT9wchIJOPz
"""

import streamlit as st
import pandas as pd
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split, GridSearchCV
from sklearn.metrics import classification_report, confusion_matrix

# ==========================================
# 1. KONFIGURASI HALAMAN
# ==========================================
st.set_page_config(
    page_title="Retail ROI Optimizer AI",
    page_icon="üõí",
    layout="wide"
)

# Custom CSS untuk mempercantik tampilan
st.markdown("""
    <style>
    .main {
        background-color: #f5f5f5;
    }
    .stMetric {
        background-color: #ffffff;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1, h2, h3 {
        color: #2c3e50;
    }
    </style>
    """, unsafe_allow_html=True)

# ==========================================
# 2. FUNGSI PREPROCESSING & FEATURE ENGINEERING
# ==========================================
def preprocess_retail_data(df, is_training=False):
    """
    Membersihkan dan membuat fitur baru.
    Logic ini SAMA PERSIS dengan yang ada di Jupyter Notebook
    untuk menjaga konsistensi data training dan testing.
    """
    df_proc = df.copy()

    # 1. Basic Metrics Calculation
    if 'revenue' not in df_proc.columns:
        df_proc['revenue'] = df_proc['unit_price'] * df_proc['units_sold']
    if 'cost' not in df_proc.columns:
        df_proc['cost'] = df_proc['unit_cost'] * df_proc['units_sold']

    # 2. Inventory Logic
    # Memastikan kolom spike_flag ada (default 0 jika tidak ada)
    if 'spike_flag' not in df_proc.columns:
        df_proc['spike_flag'] = 0

    df_proc['understock_flag'] = (df_proc['spike_flag'] == 1) & (df_proc['units_sold'] > df_proc['stock_available'])
    df_proc['overstock_flag'] = df_proc['stock_available'] > df_proc['units_sold']

    # 3. Advanced Retail Feature Engineering
    # Sell-Through Rate
    df_proc['total_stock_on_hand'] = df_proc['units_sold'] + df_proc['stock_available']
    df_proc['sell_through_rate'] = df_proc['units_sold'] / df_proc['total_stock_on_hand'].replace(0, 1)

    # Stock Cover Ratio
    df_proc['stock_cover_ratio'] = df_proc['stock_available'] / df_proc['units_sold'].replace(0, 1)

    # Profitability Drivers
    df_proc['unit_margin_ratio'] = (df_proc['unit_price'] - df_proc['unit_cost']) / df_proc['unit_price']
    df_proc['refund_rate'] = df_proc['units_refunded'] / df_proc['units_sold'].replace(0, 1)

    # Supply Chain Risk
    df_proc['lead_time_risk'] = df_proc['restock_lead_days'] * df_proc['spike_flag']

    # Jika sedang training, kita hitung Target Variable (ROI Class)
    if is_training:
        df_proc['refund_loss'] = df_proc['units_refunded'] * df_proc['unit_price']

        # Holding Cost Logic
        holding_rate = 0.10
        df_proc['excess_units'] = df_proc.apply(lambda x: max(0, x['stock_available'] - x['units_sold']) if x['overstock_flag'] else 0, axis=1)
        df_proc['holding_cost'] = (df_proc['excess_units'] * df_proc['unit_price'] * holding_rate * df_proc['restock_lead_days'])

        # Net Profit & ROI
        net_profit = df_proc['revenue'] - df_proc['cost'] - df_proc['refund_loss'] - df_proc['holding_cost']
        total_investment = df_proc['cost']
        df_proc['roi_value_net'] = (net_profit / total_investment.replace(0, 1)) * 100

        # Target Class: 1 jika ROI >= 20%, else 0
        df_proc['roi_class'] = (df_proc['roi_value_net'] >= 20).astype(int)

    return df_proc

# ==========================================
# 3. FUNGSI TRAINING MODEL (CACHED)
# ==========================================
@st.cache_resource
def train_model():
    """
    Melatih model Random Forest menggunakan data historis.
    Menggunakan cache agar tidak training ulang setiap kali user klik tombol.
    """
    # Load Data Historis (Baseline)
    url = 'https://storage.googleapis.com/dqlab-dataset/komdigi/tbl_roi.csv'
    df_train = pd.read_csv(url)

    # Preprocess Data Training
    df_processed = preprocess_retail_data(df_train, is_training=True)

    # Definisi Fitur
    feature_cols = [
        'stock_available', 'unit_margin_ratio', 'refund_rate',
        'restock_lead_days', 'sell_through_rate', 'stock_cover_ratio',
        'lead_time_risk', 'unit_price'
    ]

    X = df_processed[feature_cols]
    y = df_processed['roi_class']

    # Train Model (Menggunakan parameter terbaik dari notebook)
    model = RandomForestClassifier(
        n_estimators=200,
        max_depth=10,
        min_samples_leaf=2,
        class_weight='balanced',
        random_state=42
    )
    model.fit(X, y)

    return model, feature_cols, df_processed

# ==========================================
# 4. LOGIC REKOMENDASI BISNIS
# ==========================================
def get_recommendation(row):
    if row['Predicted_ROI_Class'] == 1 and row['Confidence_Score'] > 80:
        return "üî• STAR PRODUCT: Restock Segera & Boost Ads"
    elif row['Predicted_ROI_Class'] == 1:
        return "‚úÖ POTENTIAL: Monitor Margin Ketat"
    elif row['Predicted_ROI_Class'] == 0 and row['Confidence_Score'] > 80:
        return "‚õî DEAD STOCK: Stop Order & Cuci Gudang" # Confident 0 means sure it's bad
    else:
        return "üîç EVALUATE: Cek Biaya Operasional"

# ==========================================
# 5. UI UTAMA (STREAMLIT APP)
# ==========================================

# --- Sidebar ---
st.sidebar.image("https://cdn-icons-png.flaticon.com/512/3081/3081559.png", width=80)
st.sidebar.title("Retail AI Panel")
st.sidebar.markdown("---")
st.sidebar.header("1. Upload Data")
uploaded_file = st.sidebar.file_uploader("Upload CSV Data Baru", type=["csv"])

st.sidebar.markdown("---")
st.sidebar.info("""
**Format CSV yang dibutuhkan:**
- sku_id
- unit_price
- unit_cost
- units_sold
- stock_available
- units_refunded
- restock_lead_days
- spike_flag (1/0)
""")

# --- Main Content ---
st.title("üõí Retail ROI Optimization System")
st.markdown("### Prediksi Profitabilitas Produk & Rekomendasi Stok")

# Load & Train Model (Background Process)
with st.spinner('Sedang memuat sistem AI & melatih model pada data historis...'):
    model, feature_cols, df_history = train_model()

st.success("Sistem AI Siap! Model Random Forest aktif.")

# Tampilan jika file belum diupload
if uploaded_file is None:
    st.info("üëã Silakan upload file CSV berisi data produk baru di panel sebelah kiri untuk memulai prediksi.")

    # Tampilkan sample data historis/template
    with st.expander("Lihat Template / Contoh Data Input"):
        st.dataframe(df_history[['sku_id', 'unit_price', 'units_sold', 'stock_available']].head())

# Tampilan jika file SUDAH diupload
else:
    # A. Tampilkan Data Mentah
    input_df = pd.read_csv(uploaded_file)
    st.subheader("üìã Data Produk Baru")
    st.dataframe(input_df.head())

    # Tombol Eksekusi
    if st.button("üöÄ Jalankan Prediksi AI"):

        # B. Proses Prediksi
        try:
            # 1. Preprocessing
            X_new_processed = preprocess_retail_data(input_df, is_training=False)
            X_input = X_new_processed[feature_cols] # Filter hanya kolom fitur

            # 2. Inference
            predictions = model.predict(X_input)
            probabilities = model.predict_proba(X_input)[:, 1]

            # 3. Gabungkan Hasil
            results = input_df.copy()
            results['Predicted_ROI_Class'] = predictions
            results['Confidence_Score'] = (probabilities * 100).round(2)
            results['Action_Plan'] = results.apply(get_recommendation, axis=1)

            # C. Dashboard Hasil
            st.divider()
            st.header("üìä Hasil Analisa & Rekomendasi")

            # Metrics Summary
            col1, col2, col3, col4 = st.columns(4)
            total_products = len(results)
            high_roi_products = results[results['Predicted_ROI_Class'] == 1].shape[0]
            avg_confidence = results['Confidence_Score'].mean()
            potential_revenue = results[results['Predicted_ROI_Class'] == 1]['unit_price'].sum()

            col1.metric("Total Produk", f"{total_products} SKU")
            col2.metric("Produk High ROI", f"{high_roi_products} SKU", delta_color="normal")
            col3.metric("Rata-rata Keyakinan AI", f"{avg_confidence:.1f}%")
            col4.metric("Potensi Revenue (Est)", f"Rp {potential_revenue:,.0f}")

            # D. Tabel Detail (Highlighting)
            st.subheader("Detail Action Plan per SKU")

            def highlight_roi(val):
                color = '#d4edda' if val == 1 else '#f8d7da'
                return f'background-color: {color}'

            st.dataframe(
                results[['sku_id', 'unit_price', 'Predicted_ROI_Class', 'Confidence_Score', 'Action_Plan']]
                .style.applymap(highlight_roi, subset=['Predicted_ROI_Class']),
                use_container_width=True
            )

            # E. Visualisasi
            col_viz1, col_viz2 = st.columns(2)

            with col_viz1:
                st.subheader("Distribusi Rekomendasi")
                fig1, ax1 = plt.subplots()
                sns.countplot(y='Action_Plan', data=results, palette='viridis', order=results['Action_Plan'].value_counts().index, ax=ax1)
                st.pyplot(fig1)

            with col_viz2:
                st.subheader("Feature Importance (Driver)")
                importances = model.feature_importances_
                indices = np.argsort(importances)[::-1]
                top_features = [feature_cols[i] for i in indices[:5]]
                top_importances = importances[indices][:5]

                fig2, ax2 = plt.subplots()
                sns.barplot(x=top_importances, y=top_features, palette='magma', ax=ax2)
                ax2.set_xlabel('Relative Importance')
                st.pyplot(fig2)

            # F. Download Button
            csv = results.to_csv(index=False).encode('utf-8')
            st.download_button(
                label="üì• Download Hasil Analisa (CSV)",
                data=csv,
                file_name='hasil_prediksi_roi_retail.csv',
                mime='text/csv',
            )

        except Exception as e:
            st.error(f"Terjadi kesalahan saat memproses data: {e}")
            st.warning("Pastikan kolom CSV Anda sesuai dengan template (sku_id, unit_price, unit_cost, units_sold, stock_available, units_refunded, restock_lead_days, spike_flag).")

